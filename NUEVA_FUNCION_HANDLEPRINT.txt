// REEMPLAZAR la funci√≥n handlePrintTest() en PrinterConfiguration.tsx
// con esta versi√≥n que usa QZ Tray

const handlePrintTest = async () => {
  const testOrderCode = `${config.qr_prefix}-${Math.floor(Math.random() * 99999).toString().padStart(5, '0')}`;
  
  try {
    // Verificar si QZ Tray est√° disponible
    const qzAvailable = await isQZTrayAvailable();
    
    if (!qzAvailable) {
      toast({
        variant: 'destructive',
        title: '‚ùå QZ Tray no detectado',
        description: 'Descarga e instala QZ Tray desde qz.io/download para impresi√≥n directa'
      });
      return;
    }

    toast({
      title: 'üîå Conectando con impresora...',
      description: 'Preparando impresi√≥n directa'
    });

    // Items de ejemplo
    const testItems = [
      { name: 'Producto de Prueba', price: 10.00, quantity: 1 },
      { name: 'Combo de Prueba', price: 15.00, quantity: 1 }
    ];

    // Generar contenido del TICKET con comandos ESC/POS
    const ticketContent = generateTicketContent(
      config.business_name || selectedSchoolName,
      config.business_ruc,
      config.business_address,
      config.business_phone,
      testOrderCode,
      testItems,
      25.00,
      config.print_header ? config.header_text : undefined,
      config.print_footer ? config.footer_text : undefined
    );

    // Imprimir TICKET
    await printTicketDirect(
      config.printer_device_name,
      ticketContent,
      config.auto_cut_paper,
      config.cut_mode
    );

    // Si hay comanda activada, imprimirla tambi√©n
    if (config.print_comanda && config.print_separate_comanda) {
      const comandaItems = [
        { name: 'Producto de Prueba', quantity: 1, notes: 'Sin observaciones' },
        { name: 'Combo de Prueba', quantity: 1, notes: 'Incluye bebida' }
      ];

      const comandaContent = generateComandaContent(
        config.comanda_header,
        testOrderCode,
        comandaItems,
        'Cliente PRUEBA'
      );

      // Imprimir COMANDA
      await printTicketDirect(
        config.printer_device_name,
        comandaContent,
        config.auto_cut_paper,
        config.cut_mode
      );
    }

    toast({
      title: '‚úÖ Impresi√≥n exitosa',
      description: `C√≥digo: ${testOrderCode} ${config.print_comanda ? '(Ticket + Comanda)' : '(Solo Ticket)'}`
    });

  } catch (error: any) {
    console.error('Error de impresi√≥n:', error);
    toast({
      variant: 'destructive',
      title: '‚ùå Error de impresi√≥n',
      description: error.message || 'No se pudo imprimir. Verifica que QZ Tray est√© activo.'
    });
  }
};
